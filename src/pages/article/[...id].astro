---
import App from '@components/App.astro'
import Footer from '@components/base/Footer.astro'
import Header from '@components/base/Header.astro'
import Markdown from '@components/notebook/Markdown.astro'
import { navs } from '@libs/consts'
import { getCollection, type CollectionEntry } from 'astro:content'
import type { Archive, Article } from 'types'

export const format = (data: Archive): Article => ({
  name: data.title,
  description: data.description,
  id: data.name,
  license: data.license,
  date: {
    created: data['create-date'],
    updated: data.date,
  },
  cover: undefined,
  tags: undefined,
  subtitle: undefined,
  draft: false,
})

export async function getStaticPaths() {
  const articles = (await getCollection('文章')).filter(
    entry => import.meta.env.DEV || !entry.data.draft
  )
  const archives = (await getCollection('存档')).map(({ data, ...props }) => ({
    ...props,
    data: { ...data, ...format(data) },
  }))
  return [...articles, ...archives].map(entry => ({
    params: { id: entry.data.id },
    props: { entry },
  }))
}

const { entry } = Astro.props as { entry: CollectionEntry<'文章'> }
const { Content, headings } = await entry.render()
---

<App
  scope="记录干杯"
  name={entry.data.name}
  description={entry.data.description}
>
  <Header slot="header" action="目录" links={navs} contents={headings} />
  <Footer slot="footer" />
  <Markdown frontmatter={entry.data}>
    <Content />
  </Markdown>
</App>
